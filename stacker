#!/usr/bin/env coffee

require('es6-promise').polyfill()

require 'colors'
_ = require 'lodash'
rally = require './rally'
stacker = require './lib/stacker_lib'
task_config = require('./task_config').get_task_config()
opts = require './cli_opts'
util = require './util/util'
config = require('./lib/config_lib').get_config()

require('climet-client')()

# array of strings
tasks = rally.get_tasks_to_start(opts._, opts)

# must call this first because the register task config depends on it
stacker.initialize_env opts.stacker_env

stacker.register_task_config task_config

process.on 'uncaughtException', (error) ->
  util.log_error 'unhandled exception!'
  console.log error
  console.log error.stack

# DO IT!
stacker.boot(tasks, !opts['no-repl'])
